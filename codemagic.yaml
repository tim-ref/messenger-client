# Automatically generated on 2023-01-25 UTC from https://codemagic.io/app/63cfa7a53eb834c7a1f6e722/settings
# Note that this configuration is not an exact match to UI settings. Review and adjust as necessary.

workflows:
  default-workflow:
    name: Default Workflow build android apk and upload to saucelabs
    labels:
      - Android
      - testdriver enabled
      - debugWidget enabled
      - tokenDispenser enabled
      - saucelabs upload
    instance_type: linux
    triggering:
      events: # List the events that trigger builds
        - push
        - pull_request
        - tag
      branch_patterns: # Include or exclude watched branches
        - pattern: 'main'
          include: true
          source: true
      cancel_previous_builds: false  # Set to `true` to automatically cancel outdated webhook builds
    max_build_duration: 60
    environment:
      android_signing:
        - timref_keystore
      groups:
        - firebase_credentials
        - saucelabs_credentials
        - tokendispenser_credentials
      flutter: fvm
    cache:
      cache_paths:
        - $CM_BUILD_DIR/futter/cache
    scripts:
      - &set_up_local_properties
        name: set up local properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$FCI_BUILD_DIR/android/local.properties"
      - &set_up_debug_keystore
        name: set up debug keystore
        script: |
          rm -f ~/.android/debug.keystore
          keytool -genkeypair \
            -alias androiddebugkey \
            -keypass android \
            -keystore ~/.android/debug.keystore \
            -storepass android \
            -dname 'CN=Android Debug,O=Android,C=US' \
            -keyalg 'RSA' \
            -keysize 2048 \
            -validity 10000
      - &load_firebase_configuration
        name: Load Firebase configuration
        script: |
          #!/usr/bin/env sh
          set -e # exit on first failed command
          echo $ANDROID_FIREBASE_SECRET > $CM_BUILD_DIR/android/app/google-services.json
          echo $IOS_FIREBASE_SECRET > $CM_BUILD_DIR/ios/Runner/GoogleService-Info.plist
      - name: Check saucelab connection
        script: |
          curl -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" --location --request GET 'https://api.eu-central-1.saucelabs.com/rest/v1/info/status'
      - &set_up_code_signing_android
        name: Set up key.properties
        script: |
          cat >> "$CM_BUILD_DIR/android/key.properties" <<EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_PASSWORD
          keyAlias=$CM_KEY_ALIAS
          storeFile=$CM_KEYSTORE_PATH
          EOF
      - &get_flutter_packages
        name: Get Flutter packages
        script: |
          flutter packages pub get
      - name: Build APK with flutter
        script:
          flutter build apk --debug --dart-define=ENABLE_TEST_DRIVER=true --dart-define=ENABLE_DEBUG_WIDGET=true --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --build-number=$PROJECT_BUILD_NUMBER
    artifacts:
      - build/**/outputs/apk/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true
      scripts:
        - name: Upload apk to saucelabs
          script: |
            apkPath=$(find build -name "*.apk" | head -1)
            if [[ -z ${apkPath} ]]
            then
              echo "No .apk were found"
            else
              curl -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" --location \
              --request POST 'https://api.eu-central-1.saucelabs.com/v1/storage/upload' \
              --form 'payload=@"build/app/outputs/flutter-apk/app-debug.apk"' \
              --form 'name="app-debug.apk"' \
              --form 'description="'"$CM_COMMIT codemagic build $PROJECT_BUILD_NUMBER $CM_BUILD_ID"'"' \
              --fail
            fi


  -alternative-workflow:
    name: Alternative Workflow - build APP without testdriver
    labels:
      - Android
      - testdriver disabled
      - debugWidget disabled
      - tokenDispenser enabled
    instance_type: linux
    max_build_duration: 60
    environment:
      flutter: fvm
      groups:
        - firebase_credentials
        - tokendispenser_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/futter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - flutter build apk --debug --dart-define=ENABLE_TEST_DRIVER=false --dart-define=ENABLE_DEBUG_WIDGET=false --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --build-number=$PROJECT_BUILD_NUMBER
    artifacts:
      - build/**/outputs/apk/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true

  -alternative-workflow-no-token-dispenser:
    name: Alternative Workflow - build APK without testdriver, token dispenser disabled
    labels:
      - Android
      - testdriver disabled
      - debugWidget disabled
    instance_type: linux
    max_build_duration: 60
    environment:
      flutter: fvm
      groups:
        - versions
        - firebase_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/futter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - flutter build apk --debug --dart-define=ENABLE_TEST_DRIVER=false --dart-define=ENABLE_DEBUG_WIDGET=false --build-number=$PROJECT_BUILD_NUMBER
    artifacts:
      - build/**/outputs/apk/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true

  -ios-workflow:
    name: iOS Workflow - build iOS app - without testdriver
    labels:
      - iOS
      - testdriver disabled
      - debugWidget disabled
    max_build_duration: 60
    environment:
      ios_signing:
        provisioning_profiles:
          - "TIMRef Provisioning"
        certificates:
          - "TIMRef Distribution"
      flutter: fvm
      xcode: 14.3
      cocoapods: default
      groups:
        - firebase_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/futter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - &set_up_code_signing_ios
        name: Set up code signing settings on Xcode project
        script: xcode-project use-profiles
      - find . -name "Podfile" -execdir pod install \;
      - flutter build ipa --debug --export-options-plist=/Users/builder/export_options.plist --build-number=$PROJECT_BUILD_NUMBER

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true

  -ios-workflow-testdriver:
    name: iOS Workflow - testdriver enabled
    labels:
      - iOS
      - testdriver enabled
      - debugWidget enabled
      - tokenDispenser enabled
    max_build_duration: 60
    environment:
      ios_signing:
        provisioning_profiles:
          - "TIMRef Provisioning"
        certificates:
          - "TIMRef Distribution"
      flutter: fvm
      xcode: 14.3
      cocoapods: default
      groups:
        - firebase_credentials
        - tokendispenser_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/flutter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - *set_up_code_signing_ios
      - find . -name "Podfile" -execdir pod install \;
      - flutter build ipa --profile --dart-define=ENABLE_TEST_DRIVER=true --dart-define=ENABLE_DEBUG_WIDGET=true --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --export-options-plist=/Users/builder/export_options.plist --build-number=$PROJECT_BUILD_NUMBER

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true

  -android-publish-workflow:
    name: Build and Publish Android only
    labels:
      - android
      - release
      - tokenDispenser enabled
    max_build_duration: 60
    environment:
      ios_signing:
        provisioning_profiles:
          - "TIMRef Provisioning"
        certificates:
          - "TIMRef Distribution"
      android_signing:
        - timref_keystore
      flutter: fvm
      groups:
        - google_credentials
        - firebase_credentials
        - tokendispenser_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/flutter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - *set_up_code_signing_android
      - flutter build appbundle --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --build-number=$(($PROJECT_BUILD_NUMBER + 3360))
    artifacts:
      - build/**/outputs/bundle/**/*.aab
      - build/**/outputs/**/mapping.txt
    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true

  -android-release-mode-apk-workflow:
    name: Build an Android apk in release mode without publishing
    labels:
      - android
      - release
      - tokenDispenser disabled
    max_build_duration: 60
    environment:
      android_signing:
        - timref_keystore
      flutter: fvm
      groups:
        - google_credentials
        - firebase_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/flutter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - *set_up_code_signing_android
      - flutter build apk --build-number=$(($PROJECT_BUILD_NUMBER + 3360))
    artifacts:
      - build/**/outputs/apk/**/*.apk
      - build/**/outputs/**/mapping.txt

  -App-release-workflow:
    name: Release Android and iOS - no testdriver
    labels:
      - iOS
      - android
      - release
      - tokenDispenser enabled
    max_build_duration: 60
    environment:
      ios_signing:
        provisioning_profiles:
          - "TIMRef Provisioning"
        certificates:
          - "TIMRef Distribution"
      android_signing:
        - timref_keystore
      flutter: fvm
      xcode: 14.3
      cocoapods: default
      groups:
        - google_credentials
        - firebase_credentials
        - tokendispenser_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/flutter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - *set_up_code_signing_ios
      - *set_up_code_signing_android
      - find . -name "Podfile" -execdir pod install \;
      - flutter build ipa --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --export-options-plist=/Users/builder/export_options.plist --build-number=$(($PROJECT_BUILD_NUMBER + 3360))
      - flutter build appbundle --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --build-number=$(($PROJECT_BUILD_NUMBER + 3360))
    artifacts:
      - build/ios/ipa/*.ipa
      - build/**/outputs/bundle/**/*.aab
      - build/**/outputs/**/mapping.txt
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    integrations:
      app_store_connect: akquinet GmbH
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        expire_build_submitted_for_review: false
        submit_to_app_store: true
        release_type: MANUAL
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true
  -App-release-publish-workflow-iOS:
    name: Release and publish iOS - no testdriver
    labels:
      - iOS
      - release
      - tokenDispenser disabled
    max_build_duration: 60
    environment:
      ios_signing:
        provisioning_profiles:
          - "TIMRef Provisioning"
        certificates:
          - "TIMRef Distribution"
      flutter: fvm
      xcode: 14.3
      cocoapods: default
      groups:
        - firebase_credentials
    cache:
      cache_paths:
        - $CM_BUILD_DIR/flutter/cache
    scripts:
      - *set_up_debug_keystore
      - *set_up_local_properties
      - *load_firebase_configuration
      - *get_flutter_packages
      - *set_up_code_signing_ios
      - find . -name "Podfile" -execdir pod install \;
      - flutter build ipa --dart-define=TOKEN_DISPENSER_USER=$TOKEN_DISPENSER_USER --dart-define=TOKEN_DISPENSER_PASSWORD=$TOKEN_DISPENSER_PASSWORD --dart-define=TOKEN_DISPENSER_URL=$TOKEN_DISPENSER_URL --export-options-plist=/Users/builder/export_options.plist --build-number=$(($PROJECT_BUILD_NUMBER + 3360))
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    integrations:
      app_store_connect: akquinet GmbH
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        expire_build_submitted_for_review: false
        submit_to_app_store: true
        release_type: MANUAL
      email:
        recipients:
          - gordon@silpion.de
          - kirill.krysov@akquinet.de
          - veronika.bertels@akquinet.de
        notify:
          success: true
          failure: true
